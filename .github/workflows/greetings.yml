name: Greetings

on: [pull_request_target, issues]

jobs:
  greeting:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      # Step 1: First-time contributor greeting
      - uses: actions/first-interaction@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          issue-message: |
            ğŸ‘‹ Hey there, welcome to the project!  
            
            Thanks for opening your **first issue** ğŸ‰  
            We really appreciate your contribution.  

            ğŸ”— Donâ€™t forget to check out our [CONTRIBUTING.md](./CONTRIBUTING.md) guide.  
            Letâ€™s build something awesome together ğŸš€
          pr-message: |
            ğŸ‰ Woohoo! Thanks for submitting your **first PR** ğŸš€  

            Your contribution means a lot â¤ï¸  
            Our maintainers will review it soon.  

            ğŸ› ï¸ Tip: Make sure your code follows best practices and project style.  
            Keep contributing, keep innovating âš¡

      # Step 2: Returning contributor greeting
      - name: Returning contributor message
        if: github.event_name == 'issues' || github.event_name == 'pull_request_target'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const user = context.payload.sender.login;
            const issueOrPrNumber = context.issue.number;
            const isPR = !!context.payload.pull_request;

            // Skip if it's the contributor's first interaction (first-interaction already handled it)
            const events = await github.rest.activity.listRepoEvents({
              owner: context.repo.owner,
              repo: context.repo.repo
            });

            const userEvents = events.data.filter(e => e.actor.login === user);

            if (userEvents.length > 1) {
              const message = isPR
                ? `ğŸ‘‹ Welcome back @${user}! Thanks for another PR ğŸ‰\nWe appreciate your continued contributions ğŸš€`
                : `ğŸ™Œ Hey @${user}, welcome back! Thanks for opening another issue ğŸ“\nYour dedication keeps the project improving ğŸ’¡`;

              if (isPR) {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueOrPrNumber,
                  body: message
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueOrPrNumber,
                  body: message
                });
              }
            }
